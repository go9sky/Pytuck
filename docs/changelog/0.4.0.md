# Changelog - v0.4.0

> 发布日期 / Release Date: 2026-01-23

---

## 中文

### 新增

- **扩展字段类型支持**：新增 5 种字段类型，总计支持 10 种类型
  - 新增类型：`datetime`, `date`, `timedelta`, `list`, `dict`
  - 原有类型：`int`, `str`, `float`, `bool`, `bytes`
  - 所有 6 种存储引擎均支持新类型的序列化/反序列化
  - 使用示例：
    ```python
    from datetime import datetime, date, timedelta

    class Event(Base):
        __tablename__ = 'events'
        id = Column(int, primary_key=True)
        created_at = Column(datetime)
        event_date = Column(date)
        duration = Column(timedelta)
        tags = Column(list)
        metadata = Column(dict)
    ```

- **Binary 引擎 v4 格式**：全新的存储格式，优化大数据集性能
  - **WAL（预写日志）**：写入操作先追加到 WAL，实现 O(1) 写入延迟
  - **双 Header 机制**：HeaderA/HeaderB 交替使用，支持原子切换和崩溃恢复
  - **Generation 计数**：递增计数器用于崩溃后选择有效 Header
  - **CRC32 校验**：Header 和 WAL 条目完整性验证
  - **索引区压缩**：使用 zlib 压缩索引区域，节省约 81% 空间
  - **批量 I/O**：缓冲写入/读取，减少 I/O 操作次数
  - **编解码器缓存**：预缓存类型编解码器，避免重复查找

- **Binary 引擎加密支持**：三级加密/混淆功能，纯 Python 实现，零外部依赖
  - **低级（low）**：XOR 混淆，防随手查看，读取性能税约 100%
  - **中级（medium）**：LCG 流密码，防普通用户，读取性能税约 400%
  - **高级（high）**：ChaCha20 纯 Python 实现，密码学安全，读取性能税约 2000%
  - 加密范围：Data Region 和 Index Region（Schema Region 保持明文便于格式探测）
  - 新增 `EncryptionError` 异常类
  - 使用示例：
    ```python
    from pytuck import Storage
    from pytuck.common.options import BinaryBackendOptions

    # 创建加密数据库
    opts = BinaryBackendOptions(encryption='high', password='mypassword')
    db = Storage('data.db', engine='binary', backend_options=opts)
    ```

### 改进

- **TypeRegistry 统一类型编解码**
  - 新增 `get_type_name()` / `get_type_by_name()` 类型名称映射
  - 新增 `serialize_for_text()` / `deserialize_from_text()` 文本序列化接口
  - 所有文本后端（JSON/CSV/Excel/XML/SQLite）统一使用 TypeRegistry
  - 移除各后端重复的 `type_map` 定义，代码更简洁

- **JSON 后端格式优化**
  - 移除冗余的 `_type`/`_value` 自描述格式
  - 直接存储序列化值，根据 schema 反序列化
  - JSON 文件更简洁，与其他后端格式一致

- **主键查询优化**（影响所有存储引擎）
  - 检测 `WHERE pk = value` 形式的查询，使用 O(1) 直接访问替代 O(n) 全表扫描
  - Update 和 Delete 语句均支持此优化
  - **性能提升**：单条更新/删除从毫秒级降至微秒级（~1000x 提升）

- **Binary 引擎性能提升**
  - 保存 10 万条记录：4.18s → 0.57s（7.3x 提速）
  - 加载 10 万条记录：2.91s → 0.85s（3.4x 提速）
  - 文件大小：151MB → 120MB（21% 压缩）

### 变更

- **引擎格式版本升级**
  - Binary: v3 → v4（WAL + 双 Header + 索引压缩）

### 技术细节

- 实现了完整的 WAL 写入流程：`_append_wal_entry()`, `_read_wal_entries()`, `_replay_wal()`
- Storage 层集成 WAL：写操作自动记录到 WAL，checkpoint 时批量持久化
- 新增 `TypeRegistry.get_codec_by_code()` 方法用于反向查找编解码器
- `Update._execute()` 和 `Delete._execute()` 添加主键检测逻辑

---

## English

### Added

- **Extended Field Type Support**: Added 5 new field types, now supporting 10 types total
  - New types: `datetime`, `date`, `timedelta`, `list`, `dict`
  - Existing types: `int`, `str`, `float`, `bool`, `bytes`
  - All 6 storage engines support serialization/deserialization of new types
  - Usage example:
    ```python
    from datetime import datetime, date, timedelta

    class Event(Base):
        __tablename__ = 'events'
        id = Column(int, primary_key=True)
        created_at = Column(datetime)
        event_date = Column(date)
        duration = Column(timedelta)
        tags = Column(list)
        metadata = Column(dict)
    ```

- **Binary Engine v4 Format**: New storage format optimized for large dataset performance
  - **WAL (Write-Ahead Log)**: Write operations append to WAL first, achieving O(1) write latency
  - **Dual Header Mechanism**: HeaderA/HeaderB alternating use, supporting atomic switching and crash recovery
  - **Generation Counter**: Incrementing counter for selecting valid Header after crash
  - **CRC32 Checksums**: Header and WAL entry integrity verification
  - **Index Region Compression**: Using zlib compression for index region, saving ~81% space
  - **Batch I/O**: Buffered writes/reads, reducing I/O operation counts
  - **Codec Caching**: Pre-cached type encoders/decoders, avoiding repeated lookups

- **Binary Engine Encryption Support**: Three-tier encryption/obfuscation, pure Python implementation, zero external dependencies
  - **Low Level (low)**: XOR obfuscation, prevents casual viewing, ~100% read performance tax
  - **Medium Level (medium)**: LCG stream cipher, prevents regular users, ~400% read performance tax
  - **High Level (high)**: ChaCha20 pure Python implementation, cryptographically secure, ~2000% read performance tax
  - Encryption scope: Data Region and Index Region (Schema Region remains plaintext for format probing)
  - Added `EncryptionError` exception class
  - Usage example:
    ```python
    from pytuck import Storage
    from pytuck.common.options import BinaryBackendOptions

    # Create encrypted database
    opts = BinaryBackendOptions(encryption='high', password='mypassword')
    db = Storage('data.db', engine='binary', backend_options=opts)
    ```

### Improved

- **Unified Type Codec via TypeRegistry**
  - Added `get_type_name()` / `get_type_by_name()` type name mappings
  - Added `serialize_for_text()` / `deserialize_from_text()` text serialization interfaces
  - All text backends (JSON/CSV/Excel/XML/SQLite) now use TypeRegistry for consistent serialization
  - Removed duplicate `type_map` definitions from each backend, cleaner code

- **JSON Backend Format Optimization**
  - Removed redundant `_type`/`_value` self-describing format
  - Stores serialized values directly, deserializes based on schema
  - JSON files are more concise, consistent with other backends

- **Primary Key Query Optimization** (affects ALL storage engines)
  - Detects `WHERE pk = value` style queries, using O(1) direct access instead of O(n) full table scan
  - Both Update and Delete statements support this optimization
  - **Performance Boost**: Single update/delete reduced from milliseconds to microseconds (~1000x improvement)

- **Binary Engine Performance Improvements**
  - Save 100k records: 4.18s → 0.57s (7.3x faster)
  - Load 100k records: 2.91s → 0.85s (3.4x faster)
  - File size: 151MB → 120MB (21% reduction)

### Changed

- **Engine Format Version Upgrade**
  - Binary: v3 → v4 (WAL + Dual Header + Index Compression)

### Technical Details

- Implemented complete WAL write workflow: `_append_wal_entry()`, `_read_wal_entries()`, `_replay_wal()`
- Storage layer WAL integration: write operations automatically logged to WAL, batch persistence during checkpoint
- Added `TypeRegistry.get_codec_by_code()` method for reverse codec lookup
- `Update._execute()` and `Delete._execute()` added primary key detection logic
