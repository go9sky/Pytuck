# Changelog - v0.5.0

> 发布日期 / Release Date: 2026-01-25

---

## 中文

### 新增

- **Schema 同步与迁移功能**
  - 支持在程序第二次启动加载已有数据库时自动同步表结构
  - 新增 `SyncOptions` 配置类，控制同步行为：
    - `sync_table_comment`：是否同步表备注（默认 True）
    - `sync_column_comments`：是否同步列备注（默认 True）
    - `add_new_columns`：是否添加新列（默认 True）
    - `drop_missing_columns`：是否删除缺失的列（默认 False，危险操作）
  - 新增 `SyncResult` 结果类，记录同步变更详情
  - `declarative_base()` 新增 `sync_schema` 和 `sync_options` 参数，支持模型定义时自动同步
  - 三层 API 设计，支持不同使用场景：
    - **Table 层**：`table.add_column()`, `table.drop_column()`, `table.update_comment()` 等
    - **Storage 层**：`storage.sync_table_schema()`, `storage.add_column()`, `storage.drop_table()`, `storage.rename_table()` 等
    - **Session 层**：`session.sync_schema()`, `session.add_column()`, `session.drop_column()` 等
  - 支持 SQLite 原生 SQL 模式下的 DDL 操作（ALTER TABLE）
  - 支持纯表名 API（无需模型类），便于 Pytuck-view 等外部工具调用
  - 新增 26 个测试用例

- **Excel 后端行号映射功能**
  - 新增 `row_number_mapping` 选项，支持将 Excel 物理行号用作主键或映射到指定字段
  - `row_number_mapping='as_pk'`：将行号直接作为主键值
  - `row_number_mapping='field'`：将行号映射到指定字段（默认 `row_num`）
  - `row_number_field_name`：自定义行号字段名称
  - `row_number_override`：在 Pytuck 创建的文件中强制应用行号映射
  - `persist_row_number`：保存时持久化行号字段
  - 支持读取外部 Excel 文件（无 Pytuck 元数据）
  - 新增 Excel 行号映射专项测试（11 个测试用例）

### 改进

- **SQLite 原生 SQL 模式优化**
  - SQLite 后端默认启用原生 SQL 模式（`use_native_sql=True`），直接执行 SQL 而非全量加载/保存
  - 完善 `TYPE_TO_SQL` 映射，支持全部 10 种 Pytuck 类型：
    - 基础类型：`int`, `str`, `float`, `bool`, `bytes`
    - 扩展类型：`datetime`, `date`, `timedelta`, `list`, `dict`
  - 完善 `SQL_TO_TYPE` 反向映射，支持外部 SQLite 数据库类型推断
  - 新增原生 SQL 模式专项测试（11 个测试用例）
  - 修复 NULL 值查询问题（使用 `IS NULL` 而非 `= NULL`）
  - 支持多列排序

- **迁移工具延迟加载后端支持**
  - 修复 `migrate_engine()` 在源后端使用延迟加载模式时数据为空的问题
  - `StorageBackend` 基类新增 `supports_lazy_loading()` 方法
  - `StorageBackend` 基类新增 `populate_tables_with_data()` 方法
  - `StorageBackend` 基类新增 `save_full()` 方法
  - 新增延迟加载后端迁移专项测试（5 个测试用例）

- **后端注册器优化**：使用 `__init_subclass__` 实现自动注册
  - `StorageBackend` 基类新增 `__init_subclass__` 方法，子类定义时自动注册到 `BackendRegistry`
  - 移除了 `BackendRegistry._discover_backends()` 硬编码发现逻辑
  - 用户自定义后端只需继承 `StorageBackend` 并定义 `ENGINE_NAME` 即可自动注册

- **Relationship 关联关系优化**
  - 支持使用表名字符串定义双向关联
  - 新增 Storage 级别模型注册表（`_model_registry`）
  - 新增 `uselist` 参数，支持自引用场景显式指定返回类型
  - 支持 IDE 类型提示
  - 新增全面的 Relationship 测试
  - 新增 `examples/relationship_demo.py` 综合示例

### 重构

- **后端模块结构优化**
  - `pytuck/backends/__init__.py` 简化为仅导入/导出职责
  - `pytuck/backends/registry.py` 移除 `_initialized` 和 `_discover_backends()`
  - 内置后端在 `__init__.py` 中显式导入，触发自动注册

- **异常系统重构**
  - 重构 `PytuckException` 基类，添加通用字段
  - 添加 `to_dict()` 方法
  - 新增异常类型：`TypeConversionError`、`ConfigurationError`、`SchemaError`、`QueryError`、`ConnectionError`、`UnsupportedOperationError`
  - 统一替换所有内置异常为自定义异常类型

### 破坏性变更

- **Column 定义 API 简化**
  - `Column` 构造函数签名变更：`col_type` 现在是第一个位置参数，`name` 变为可选关键字参数
  - `name` 参数默认使用变量名
  - 所有其他参数现在必须使用关键字形式传递

- **查询结果 API 简化**
  - 移除 `Result.scalars()` 方法，直接使用 `Result.all()`/`first()`/`one()`/`one_or_none()`
  - 移除 `Result.rows()` 方法
  - 移除 `Result.fetchall()` 方法
  - 移除 `Row` 类
  - `ScalarResult` 改为内部类 `_ScalarResult`

---

## English

### Added

- **Schema Sync & Migration**
  - Support automatic schema synchronization when loading existing database on program restart
  - Added `SyncOptions` configuration class to control sync behavior
  - Added `SyncResult` result class to record sync change details
  - `declarative_base()` now supports `sync_schema` and `sync_options` parameters
  - Three-layer API design: Table → Storage → Session
  - Support for SQLite native SQL mode DDL operations (ALTER TABLE)
  - Support for pure table-name API (no model class required)
  - Added 26 test cases

- **Excel Row Number Mapping**
  - Added `row_number_mapping` option to use Excel physical row numbers as primary key or map to a field
  - `row_number_mapping='as_pk'`: Use row number directly as primary key value
  - `row_number_mapping='field'`: Map row number to a specified field
  - Support for loading external Excel files (without Pytuck metadata)
  - Added dedicated Excel row number mapping tests (11 test cases)

### Improved

- **SQLite Native SQL Mode Optimization**
  - SQLite backend now defaults to native SQL mode (`use_native_sql=True`)
  - Completed `TYPE_TO_SQL` mapping for all 10 Pytuck types
  - Completed `SQL_TO_TYPE` reverse mapping for external SQLite database type inference
  - Added dedicated native SQL mode tests (11 test cases)
  - Fixed NULL value query issue (using `IS NULL` instead of `= NULL`)
  - Multi-column ORDER BY support

- **Migration Tool Lazy Loading Backend Support**
  - Fixed `migrate_engine()` returning empty data when source backend uses lazy loading mode
  - Added `supports_lazy_loading()`, `populate_tables_with_data()`, `save_full()` methods to `StorageBackend` base class
  - Added dedicated lazy loading backend migration tests (5 test cases)

- **Backend Registry Optimization**: Automatic registration using `__init_subclass__`
  - User-defined backends only need to inherit `StorageBackend` and define `ENGINE_NAME` for automatic registration

- **Relationship Enhancement**
  - Support defining bidirectional relationships using table name strings
  - Added Storage-level model registry (`_model_registry`)
  - Added `uselist` parameter for self-referential relationships
  - IDE type hint support
  - Added comprehensive Relationship tests
  - Added `examples/relationship_demo.py` comprehensive example

### Refactored

- **Backend Module Structure Optimization**
  - Simplified `pytuck/backends/__init__.py` to import/export responsibilities only
  - Removed `_initialized` and `_discover_backends()` from `pytuck/backends/registry.py`
  - Built-in backends explicitly imported in `__init__.py` to trigger automatic registration

- **Exception System Refactoring**
  - Refactored `PytuckException` base class with common fields
  - Added `to_dict()` method for logging and serialization
  - New exception types: `TypeConversionError`, `ConfigurationError`, `SchemaError`, `QueryError`, `ConnectionError`, `UnsupportedOperationError`
  - Unified replacement of all built-in exceptions with custom exception types

### Breaking Changes

- **Column Definition API Simplification**
  - `Column` constructor signature changed: `col_type` is now the first positional argument, `name` becomes an optional keyword argument
  - `name` parameter defaults to the variable name
  - All other parameters now must be passed as keyword arguments

- **Query Result API Simplification**
  - Removed `Result.scalars()` method, use `Result.all()`/`first()`/`one()`/`one_or_none()` directly
  - Removed `Result.rows()` method
  - Removed `Result.fetchall()` method
  - Removed `Row` class
  - `ScalarResult` changed to internal class `_ScalarResult`
