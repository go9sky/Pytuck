# Changelog - v0.6.2

> 发布日期 / Release Date: 2026-02-01

---

## 中文

### 新增

- **Storage.count_rows() 方法**
  - 新增获取表记录数的公共接口
  - 支持 Native SQL 模式和内存模式
  - 表不存在时抛出 `TableNotFoundError`
  - 示例：
    ```python
    count = storage.count_rows('users')
    print(f"users 表有 {count} 条记录")
    ```

- **主键类型自动转换**
  - 在 `Table` 类中添加 `_normalize_pk` 方法
  - `insert`、`update`、`delete`、`get` 方法自动转换主键类型
  - 解决传入字符串主键 `'1'` 与整数主键 `1` 不匹配的问题

### 修复

- **主键重复检测失败**
  - 修复内存模式下主键类型不匹配导致重复检测失败的问题
  - 表定义 `int` 主键，传入 `'1'`（字符串）现在能正确检测到与 `1`（整数）重复

- **主键重复异常统一**
  - Native SQL 模式下插入重复主键现在抛出 `DuplicateKeyError` 而非 `sqlite3.IntegrityError`

- **insert 返回值修正**
  - 用户指定主键时返回用户提供的值，而非 SQLite 的 `lastrowid`
  - 修复 insert 后立即 delete 失败的问题

- **delete 无主键表处理**
  - 统一无主键表的删除操作使用 `rowid`

- **外部文件加载列名映射**
  - 修复 `load_table` 使用 `Column(type, name='xxx')` 时列名映射问题

- **mypy 类型检查错误**
  - 修复 `orm.py` 中 datetime/date 类型转换的类型检查错误

### 文档

- 更新列操作方法的文档说明
- 更新 README 中的 GitHub 和 Gitee 链接

### 测试

- 添加 `test_insert_issues.py`：主键重复、返回值、insert+delete 联动测试
- 添加 `test_count_rows.py`：count_rows 方法测试
- 添加 `TestPkTypeMismatch`：主键类型不匹配场景测试
- 添加 Column.name 映射在 Schema 操作中的测试

---

## English

### Added

- **Storage.count_rows() Method**
  - Added public interface to get table record count
  - Supports both Native SQL mode and memory mode
  - Raises `TableNotFoundError` when table doesn't exist
  - Example:
    ```python
    count = storage.count_rows('users')
    print(f"users table has {count} records")
    ```

- **Primary Key Type Auto-Conversion**
  - Added `_normalize_pk` method in `Table` class
  - `insert`, `update`, `delete`, `get` methods now auto-convert primary key types
  - Resolves mismatch between string primary key `'1'` and integer primary key `1`

### Fixed

- **Primary Key Duplicate Detection Failure**
  - Fixed duplicate detection failure in memory mode when primary key types don't match
  - Table defined with `int` primary key, passing `'1'` (string) now correctly detects duplicate with `1` (integer)

- **Unified Primary Key Duplicate Exception**
  - Native SQL mode now raises `DuplicateKeyError` instead of `sqlite3.IntegrityError` for duplicate primary keys

- **insert Return Value Fix**
  - Returns user-provided value when user specifies primary key, instead of SQLite's `lastrowid`
  - Fixed delete failure immediately after insert

- **delete for Primary Key-less Tables**
  - Unified delete operation for primary key-less tables to use `rowid`

- **External File Loading Column Name Mapping**
  - Fixed column name mapping issue when using `Column(type, name='xxx')` with `load_table`

- **mypy Type Check Error**
  - Fixed type check error for datetime/date type conversion in `orm.py`

### Documentation

- Updated documentation for column operation methods
- Updated GitHub and Gitee links in README

### Tests

- Added `test_insert_issues.py`: Primary key duplicate, return value, insert+delete integration tests
- Added `test_count_rows.py`: count_rows method tests
- Added `TestPkTypeMismatch`: Primary key type mismatch scenario tests
- Added Column.name mapping tests for Schema operations
